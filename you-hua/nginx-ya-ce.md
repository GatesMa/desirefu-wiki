# nginx压测

nginx的性能是很强的，有文章称QPS能达到百万，对于大部分的网站来说都够用了，但是还是需要确认一下，nginx的性能不会成为系统qps的瓶颈，所以我们需要对我们服务用到的nginx进行压力测试，看看具体的性能有多少，我们不对nginx进行转发，而是测试nginx错误页面的地址，看看机器的状态是否正常。

## 一  测试内容

本次测试是针对nginx进行的压力测试，查看nginx是否会成为系统的性能瓶颈。

## 二  测试方法

本次采用apache的开源测试工具jmeter。

## 三  测试目标

1\) 获取在单机部署情况下最大TPS值。2\) 是否可以达到原来预期值QPS：500。对于系统QPS来说，500已经足够应对大部分情况下同学们访问服务了，对于瞬时大量用户同时请求的情况虽然目前还是没有办法应对，但是在当前机器环境下已经很不错了。所以500QPS是足够用的，况且安装nginx的机器只有1核2g的入门机器，但是nginx在大部分情况下不会成为系统的瓶颈。

## 四  测试环境

| **环境** | **机器型号** | **操作系统** | **硬件cpu** | **硬件mem** |
| :--- | :--- | :--- | :--- | :--- |
| 客户端 | mac | windows | 4核 | 8G |
| 服务端 | x86\_64 | linux | 1核 | 2G |

## 五  性能测试结果与分析

### 5.1 每秒100线程循环

启100个进程，每个进程启动1个线程，并发为100

| **Label** | **\#Samples** | 平均 | **中位数** | **最小** | **最大** | **Error%** |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | 2036 | 316 | 40 | 35 | 11385 | 0.00% |
| 2 | 8153 | 456 | 41 | 35 | 49494 | 0.00% |
| 3 | 16668 | 521 | 41 | 35 | 85348 | 0.04% |
| 4 | 22964 | 548 | 41 | 35 | 85348 | 0.08% |

聚合报告：错误率可以忽略（主要是因为链接短暂关闭引起的超时或网络波动），平均响应时间不错。

![](../.gitbook/assets/image%20%2865%29.png)

Bytes throughput Over Time：吞吐量变化幅度小

![](../.gitbook/assets/image%20%2861%29.png)

Latencies Over Time：脚本运行期间，发送一个完整的请求所需时间的变化趋势图

![](../.gitbook/assets/image%20%2859%29.png)

机器状态：nginx占用cpu极少可以忽略。

### 5.2 每秒500线程循环

每秒启500个进程，每个进程启动1个线程，并发为500

| **Label** | **\#Samples** | 平均 | **中位数** | **最小** | **最大** | **Error%** |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | 1232 | 357 | 40 | 35 | 40818 | 0.00% |
| 2 | 6667 | 512 | 40 | 35 | 40818 | 0.00% |
| 3 | 11313 | 729 | 41 | 35 | 71775 | 0.18% |
| 4 | 14895 | 812 | 41 | 35 | 93457 | 1.97% |
| 5 | 20259 | 809 | 41 | 35 | 115873 | 1.59% |

聚合报告：错误率有提升，但是依旧在可控范围内。

![](../.gitbook/assets/image%20%2860%29.png)

![](../.gitbook/assets/image%20%2862%29.png)

Latencies Over Time：只有后面关闭链接之后波动较大

![](../.gitbook/assets/image%20%2863%29.png)

### 5.3 每秒1000线程循环

每秒启1000个进程，每个进程启动1个线程，并发为1000

| **Label** | **\#Samples** | 平均 | **中位数** | **最小** | **最大** | **Error%** |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | 1123 | 456 | 43 | 34 | 7669 | 0.00% |
| 2 | 6609 | 3812 | 517 | 34 | 18951 | 37.81% |
| 3 | 14463 | 3593 | 292 | 34 | 63549 | 34.64% |
| 4 | 19096 | 3440 | 285 | 34 | 83283 | 31.06% |
| 5 | 23101 | 3258 | 281 | 34 | 83283 | 26.39% |

聚合报告：错误率提升较大，已经不在可控范围内，稳定在3成左右，此时系统已经出现了大部分错误， 不能正常提供服务了。

机器CPU等状态依旧正常，说明与机器无关。

![](../.gitbook/assets/image%20%2864%29.png)



**结论**：最终，经测试，每秒线程数在550左右时为极限，再多就会出现大量错误。

